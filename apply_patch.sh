#!/bin/bash

# üîÑ –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ç—á–∞ –º–∏–≥—Ä–∞—Ü–∏–∏
# DOGE Trading Bot v4.1 ‚Üí v4.1-refactored

echo "üîÑ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ü–ê–¢–ß –ú–ò–ì–†–ê–¶–ò–ò"
echo "ü§ñ DOGE Trading Bot v4.1 ‚Üí v4.1-refactored"
echo "=============================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Python
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3.8+ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "bot.py" ] && [ ! -f "hybrid_bot.py" ] && [ ! -f "config.py" ]; then
    echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞!"
    echo "üí° –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –±–æ—Ç–æ–º"
    exit 1
fi

echo "‚úÖ –ù–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ
echo ""
echo "üéØ –ß–¢–û –ë–£–î–ï–¢ –°–î–ï–õ–ê–ù–û:"
echo "  üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã src/"
echo "  üíæ –ë—ç–∫–∞–ø –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤"
echo "  üîÑ –°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–∞–ø—Ç–µ—Ä–æ–≤ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏"
echo "  üß™ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤"
echo "  üìö –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
echo "  üöÄ –ù–æ–≤—ã–π main.py —Å –≤—ã–±–æ—Ä–æ–º —Ä–µ–∂–∏–º–æ–≤"

# –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
echo ""
read -p "‚ùì –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞"
    exit 0
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –ø–∞—Ç—á–∞
if [ ! -f "migration_patch.py" ]; then
    echo "‚ùå –§–∞–π–ª migration_patch.py –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "üí° –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ñ–∞–π–ª –ø–∞—Ç—á–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
    exit 1
fi

echo "üîÑ –ó–∞–ø—É—Å–∫ –ø–∞—Ç—á–∞ –º–∏–≥—Ä–∞—Ü–∏–∏..."
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ç—á
python3 migration_patch.py

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
if [ $? -eq 0 ]; then
    echo ""
    echo "üéâ –ú–ò–ì–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!"
    echo ""
    echo "üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
    echo "  1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: python3 main.py --validate"
    echo "  2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: pip3 install -r requirements.txt"
    echo "  3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: python3 main.py --mode hybrid"
    echo ""
    echo "üìã –î–û–°–¢–£–ü–ù–´–ï –†–ï–ñ–ò–ú–´:"
    echo "  üé≠ hybrid  - –Ω–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ + —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
    echo "  üìú legacy  - —Å—Ç–∞—Ä—ã–π –±–æ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
    echo "  üÜï new     - –ø–æ–ª–Ω–∞—è –Ω–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)"
    echo ""
    echo "üìÅ –ë–≠–ö–ê–ü–´:"
    echo "  üì¶ backup_before_migration/ - –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã"
    echo "  üìÑ main_old.py - –∫–æ–ø–∏—è —Å—Ç–∞—Ä–æ–≥–æ main.py"
    echo ""
    echo "üìö –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø:"
    echo "  üìñ README_NEW.md - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏"
    echo "  üìã CHANGELOG.md - —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
    
    # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
    echo ""
    read -p "‚ùì –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ pytest
        if command -v pytest &> /dev/null; then
            pytest tests/ -v
        else
            echo "‚ö†Ô∏è pytest –Ω–µ –Ω–∞–π–¥–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
            pip3 install pytest pytest-asyncio
            pytest tests/ -v
        fi
    fi
    
    echo ""
    echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É –≤ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ."
    
else
    echo ""
    echo "‚ùå –û–®–ò–ë–ö–ê –ú–ò–ì–†–ê–¶–ò–ò!"
    echo "üîÑ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
    echo "üí° –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö —Ñ–∞–π–ª—ã –º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ backup_before_migration/"
    exit 1
fi
